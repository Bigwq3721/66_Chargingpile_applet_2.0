# å¾®ä¿¡å°ç¨‹åºå‰ç«¯ä»£ç å…¨é¢æµ‹è¯•æŠ¥å‘Š

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

åŸºäºæ‚¨æä¾›çš„APIç¯å¢ƒæ›´æ–°ä¿¡æ¯ï¼Œæœ¬æŠ¥å‘Šå¯¹å……ç”µæ¡©å¾®ä¿¡å°ç¨‹åºå‰ç«¯ä»£ç è¿›è¡Œäº†å…¨é¢æµ‹è¯•ã€‚é‡ç‚¹å…³æ³¨APIé…ç½®å˜æ›´ã€ä»£ç è´¨é‡ã€å®‰å…¨æ€§ã€æ€§èƒ½å’Œå…¼å®¹æ€§ç­‰æ–¹é¢ã€‚

**æµ‹è¯•èŒƒå›´ï¼š** å…¨éƒ¨å‰ç«¯ä»£ç æ–‡ä»¶  
**æµ‹è¯•æ—¶é—´ï¼š** 2024å¹´å½“å‰  
**APIç¯å¢ƒå˜æ›´ï¼š** `https://ap3202.haokuaichong.cn/quickuser50/` â†’ `https://test.yueguisuchong.com/quickuser50/`

---

## ğŸ”§ APIç¯å¢ƒé…ç½®åˆ†æ

### âœ… å½“å‰APIé…ç½®çŠ¶æ€

ç»è¿‡æ£€æŸ¥ï¼Œå‘ç°ä»£ç ä¸­çš„APIé…ç½®å·²ç»æ­£ç¡®æ›´æ–°ï¼š

**æ–‡ä»¶ä½ç½®ï¼š** `common/Config.js`

```javascript
class Config {
    //æµ‹è¯•
    static baseUrl = "https://test.yueguisuchong.com"
    static api = "https://test.yueguisuchong.com/quickuser50/"
    static api1 = "https://test.yueguisuchong.com/quick_manager50/"
    static wx = "wss://test.yueguisuchong.com/quickuser50/device/ws/"
    static imgapi = "https://test.yueguisuchong.com/quickuser50"
    
    //æ­£å¼
    // static api = "https://ap3202.haokuaichong.cn/quickuser50/"
    // static api1 = "https://ap3202.haokuaichong.cn/quick_manager50/"
    // static wx = "wss://ap3202.haokuaichong.cn/quickuser50/device/ws/"
    // static imgapi = "https://ap3202.haokuaichong.cn/quickuser50/"
}
```

**âœ… å¥½æ¶ˆæ¯ï¼š** å½“å‰ç”Ÿäº§ç¯å¢ƒAPIåœ°å€å·²æ­£ç¡®é…ç½®ä¸º `https://test.yueguisuchong.com/quickuser50/`

### ğŸ”´ å‘ç°çš„APIç›¸å…³é—®é¢˜

#### 1. ç¯å¢ƒé…ç½®ç®¡ç†æ··ä¹±

**é—®é¢˜ä½ç½®ï¼š** `common/Config.js` ç¬¬12-15è¡Œ  
**é£é™©ç­‰çº§ï¼š** ğŸ”´ é«˜é£é™©

**é—®é¢˜æè¿°ï¼š** 
- ä½¿ç”¨æ³¨é‡Šæ–¹å¼åˆ‡æ¢ç¯å¢ƒï¼Œå®¹æ˜“å‡ºé”™
- ç¼ºå°‘ç¯å¢ƒå˜é‡ç®¡ç†æœºåˆ¶
- æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒé…ç½®æ··åœ¨ä¸€èµ·

**æ”¹è¿›å»ºè®®ï¼š**
```javascript
// å»ºè®®çš„ç¯å¢ƒé…ç½®æ–¹æ¡ˆ
const ENV = process.env.NODE_ENV || 'production';

const configs = {
  development: {
    baseUrl: "https://test.yueguisuchong.com",
    api: "https://test.yueguisuchong.com/quickuser50/",
    api1: "https://test.yueguisuchong.com/quick_manager50/",
    wx: "wss://test.yueguisuchong.com/quickuser50/device/ws/",
    imgapi: "https://test.yueguisuchong.com/quickuser50",
    imgUrl: "https://test.yueguisuchong.com/tabBarimg/"
  },
  production: {
    baseUrl: "https://test.yueguisuchong.com",
    api: "https://test.yueguisuchong.com/quickuser50/",
    api1: "https://test.yueguisuchong.com/quick_manager50/",
    wx: "wss://test.yueguisuchong.com/quickuser50/device/ws/",
    imgapi: "https://test.yueguisuchong.com/quickuser50",
    imgUrl: "https://test.yueguisuchong.com/tabBarimg/"
  }
};

export const Config = configs[ENV];
```

#### 2. ç¬¬ä¸‰æ–¹APIç¡¬ç¼–ç 

**é—®é¢˜ä½ç½®ï¼š** `common/Base.js` ç¬¬325è¡Œ  
**é£é™©ç­‰çº§ï¼š** ğŸŸ¡ ä¸­é£é™©

```javascript
uni.request({
    url: 'https://wxgo.adwke.com/api/kuaishou/getkspw?channel=wk240314',
    method: 'GET',
    // ç¡¬ç¼–ç çš„ç¬¬ä¸‰æ–¹APIåœ°å€
})
```

**é—®é¢˜æè¿°ï¼š** ç¬¬ä¸‰æ–¹APIåœ°å€ç¡¬ç¼–ç ï¼Œå¦‚æœæœåŠ¡å˜æ›´ä¼šå¯¼è‡´åŠŸèƒ½å¤±æ•ˆ

#### 3. å·²åºŸå¼ƒAPIåœ°å€æ®‹ç•™

**é—®é¢˜ä½ç½®ï¼š** `manifest.json` ç¬¬106è¡Œ  
**é£é™©ç­‰çº§ï¼š** ğŸŸ¡ ä¸­é£é™©

```json
// "publicPath" : "https://cdn.haokuaichong.cn/sixsix",
```

**é—®é¢˜æè¿°ï¼š** æ³¨é‡Šä¸­ä»åŒ…å«æ—§åŸŸåï¼Œå¯èƒ½é€ æˆæ··æ·†

---

## ğŸ”’ å®‰å…¨æ€§é—®é¢˜åˆ†æ

### ğŸ”´ ä¸¥é‡å®‰å…¨é—®é¢˜

#### 1. APIå¯†é’¥æ³„éœ²

**é—®é¢˜ä½ç½®ï¼š** `manifest.json` ç¬¬115è¡Œ  
**é£é™©ç­‰çº§ï¼š** ğŸ”´ é«˜é£é™©

```json
"sdkConfigs" : {
    "maps" : {
        "qqmap" : {
            "key" : "HG5BZ-GXNEX-XZ64X-7CUQR-CSZWH-MKBVK"
        }
    }
}
```

**é—®é¢˜æè¿°ï¼š** è…¾è®¯åœ°å›¾APIå¯†é’¥ç›´æ¥æš´éœ²åœ¨å‰ç«¯ä»£ç ä¸­

**å®‰å…¨å»ºè®®ï¼š**
- å°†APIå¯†é’¥ç§»è‡³æœåŠ¡ç«¯
- ä½¿ç”¨ä»£ç†æ¥å£è°ƒç”¨åœ°å›¾æœåŠ¡
- å®æ–½APIå¯†é’¥è½®æ¢æœºåˆ¶

#### 2. URLå®‰å…¨éªŒè¯ç¼ºå¤±

**é—®é¢˜ä½ç½®ï¼š** `pages/index/index.vue` ç¬¬290è¡Œ  
**é£é™©ç­‰çº§ï¼š** ğŸ”´ é«˜é£é™©

```javascript
gogd(url, jump, msg, libId, teamId) {
    if (jump == 'PU' || jump == 'SA') {
        if (url != 0) {
            uni.navigateTo({
                url: '/pages/webview/webview?url=' + url // æœªéªŒè¯URLå®‰å…¨æ€§
            });
        }
    }
}
```

**é—®é¢˜æè¿°ï¼š** ç›´æ¥ä½¿ç”¨å¤–éƒ¨URLè·³è½¬ï¼Œå­˜åœ¨XSSå’Œé’“é±¼æ”»å‡»é£é™©

**å®‰å…¨å»ºè®®ï¼š**
```javascript
// æ·»åŠ URLç™½åå•éªŒè¯
const ALLOWED_DOMAINS = [
    'test.yueguisuchong.com',
    'official-domain.com'
];

function isUrlSafe(url) {
    try {
        const urlObj = new URL(url);
        return ALLOWED_DOMAINS.includes(urlObj.hostname);
    } catch {
        return false;
    }
}

gogd(url, jump, msg, libId, teamId) {
    if (jump == 'PU' || jump == 'SA') {
        if (url != 0 && isUrlSafe(url)) {
            uni.navigateTo({
                url: '/pages/webview/webview?url=' + encodeURIComponent(url)
            });
        } else {
            uni.showToast({
                title: 'é“¾æ¥ä¸å®‰å…¨',
                icon: 'none'
            });
        }
    }
}
```

#### 3. è¾“å…¥éªŒè¯ä¸è¶³

**é—®é¢˜ä½ç½®ï¼š** `common/Base.js` ç¬¬451è¡Œ  
**é£é™©ç­‰çº§ï¼š** ğŸŸ¡ ä¸­é£é™©

```javascript
checkPhone(e) {
    if (!(/^1(3|4|5|6|7|8|9)\d{9}$/.test(e))) {
        // æ‰‹æœºå·éªŒè¯è¿‡äºç®€å•
        return false;
    }
    return true;
}
```

**æ”¹è¿›å»ºè®®ï¼š**
```javascript
checkPhone(phone) {
    // æ›´ä¸¥æ ¼çš„æ‰‹æœºå·éªŒè¯
    if (!phone || typeof phone !== 'string') {
        return false;
    }
    
    // å»é™¤ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
    const cleanPhone = phone.replace(/\s|-/g, '');
    
    // æ›´å®Œæ•´çš„æ‰‹æœºå·æ­£åˆ™
    const phoneRegex = /^1[3-9]\d{9}$/;
    
    if (!phoneRegex.test(cleanPhone)) {
        uni.showToast({
            title: "è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·",
            icon: "none"
        });
        return false;
    }
    
    return true;
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–é—®é¢˜

### ğŸŸ¡ æ€§èƒ½ç“¶é¢ˆ

#### 1. é¢‘ç¹çš„å­˜å‚¨è¯»å–

**é—®é¢˜ä½ç½®ï¼š** `pages/index/index.vue` ç¬¬166-170è¡Œ  
**æ€§èƒ½å½±å“ï¼š** ğŸŸ¡ ä¸­ç­‰

```javascript
initPageData() {
    const user = uni.getStorageSync('user');
    const userToken = uni.getStorageSync('userToken');
    // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºéƒ½é‡å¤è¯»å–å­˜å‚¨
}
```

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// å®ç°å­˜å‚¨ç¼“å­˜æœºåˆ¶
class StorageManager {
    constructor() {
        this.cache = new Map();
        this.cacheTime = new Map();
        this.TTL = 60000; // 1åˆ†é’Ÿç¼“å­˜
    }
    
    get(key) {
        const now = Date.now();
        if (this.cache.has(key) && now < this.cacheTime.get(key)) {
            return this.cache.get(key);
        }
        
        const value = uni.getStorageSync(key);
        this.cache.set(key, value);
        this.cacheTime.set(key, now + this.TTL);
        return value;
    }
    
    invalidate(key) {
        this.cache.delete(key);
        this.cacheTime.delete(key);
    }
}

const storageManager = new StorageManager();
```

#### 2. é‡å¤çš„ç½‘ç»œè¯·æ±‚ä»£ç 

**é—®é¢˜ä½ç½®ï¼š** `common/Base.js` ç¬¬167-241è¡Œ  
**é—®é¢˜æè¿°ï¼š** `request` å’Œ `request1` æ–¹æ³•ä»£ç é«˜åº¦é‡å¤

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// ç»Ÿä¸€è¯·æ±‚æ–¹æ³•ï¼Œå‡å°‘ä»£ç é‡å¤
request(url, method, data, header, apiType = 'user') {
    const baseUrl = apiType === 'user' ? this.url : this.url1;
    
    // è¯·æ±‚ç¼“å­˜æœºåˆ¶
    const cacheKey = `${method}:${baseUrl}${url}:${JSON.stringify(data)}`;
    if (this.requestCache.has(cacheKey)) {
        return Promise.resolve(this.requestCache.get(cacheKey));
    }
    
    return new Promise((resolve, reject) => {
        // ç»Ÿä¸€çš„è¯·æ±‚é€»è¾‘
        uni.request({
            url: baseUrl + url,
            method: method,
            data: data,
            header: this.buildHeaders(header),
            timeout: 15000,
            success: (res) => {
                // ç¼“å­˜æˆåŠŸå“åº”
                if (res.data.code === 200) {
                    this.requestCache.set(cacheKey, res);
                    setTimeout(() => this.requestCache.delete(cacheKey), 30000);
                }
                resolve(res);
            },
            fail: reject
        });
    });
}
```

#### 3. å›¾ç‰‡èµ„æºä¼˜åŒ–ä¸è¶³

**ä¼˜åŒ–å»ºè®®ï¼š**
- ä½¿ç”¨å›¾æ ‡å­—ä½“æ›¿ä»£å°å›¾æ ‡
- å®ç°å›¾ç‰‡æ‡’åŠ è½½
- å‹ç¼©å›¾ç‰‡èµ„æº
- ä½¿ç”¨WebPæ ¼å¼

---

## ğŸ¨ UI/UXè®¾è®¡é—®é¢˜

### ğŸŸ¡ ç”¨æˆ·ä½“éªŒé—®é¢˜

#### 1. åŠ è½½çŠ¶æ€ä¸ä¸€è‡´

**é—®é¢˜æè¿°ï¼š** éƒ¨åˆ†é¡µé¢æœ‰åŠ è½½çŠ¶æ€ï¼Œéƒ¨åˆ†æ²¡æœ‰ï¼Œç”¨æˆ·ä½“éªŒä¸ä¸€è‡´

**æ”¹è¿›å»ºè®®ï¼š**
```javascript
// ç»Ÿä¸€çš„åŠ è½½çŠ¶æ€ç®¡ç†
class LoadingManager {
    constructor() {
        this.loadingCount = 0;
    }
    
    show(title = 'åŠ è½½ä¸­...') {
        this.loadingCount++;
        if (this.loadingCount === 1) {
            uni.showLoading({
                title: title,
                mask: true
            });
        }
    }
    
    hide() {
        this.loadingCount = Math.max(0, this.loadingCount - 1);
        if (this.loadingCount === 0) {
            uni.hideLoading();
        }
    }
}
```

#### 2. é”™è¯¯æç¤ºä¸å‹å¥½

**é—®é¢˜ä½ç½®ï¼š** `common/Base.js` ç¬¬442è¡Œ

```javascript
fPrompt(arg) {
    uni.showToast({
        title: arg,
        icon: 'none'
    })
}
```

**æ”¹è¿›å»ºè®®ï¼š**
```javascript
// æ›´å‹å¥½çš„é”™è¯¯æç¤º
showError(message, actionText = 'é‡è¯•', onAction = null) {
    uni.showModal({
        title: 'æ“ä½œå¤±è´¥',
        content: message,
        confirmText: actionText,
        cancelText: 'å–æ¶ˆ',
        success: (res) => {
            if (res.confirm && onAction) {
                onAction();
            }
        }
    });
}
```

#### 3. æ— éšœç¢è®¿é—®æ”¯æŒä¸è¶³

**æ”¹è¿›å»ºè®®ï¼š**
```html
<!-- æ·»åŠ æ— éšœç¢å±æ€§ -->
<image 
    src="../../static/tabBarimg/k5.png" 
    aria-label="å……ç”µåŒºè´¹ç‡å›¾æ ‡"
    alt="å……ç”µåŒºè´¹ç‡"
    style='width:52upx;height:52upx;'>
</image>

<button 
    aria-label="æ‰«ç å……ç”µæŒ‰é’®"
    @click="smbtn">
    æ‰«ç 
</button>
```

---

## ğŸ”§ å…¼å®¹æ€§é—®é¢˜

### ğŸŸ¡ å…¼å®¹æ€§é£é™©

#### 1. æ ·å¼å…¼å®¹æ€§é—®é¢˜

**é—®é¢˜ä½ç½®ï¼š** `App.vue` ç¬¬685è¡Œ  
**é—®é¢˜æè¿°ï¼š** ä½¿ç”¨å·²åºŸå¼ƒçš„ `/deep/` è¯­æ³•

```css
/deep/.van-dialog__footer{
    display: flex!important;
}
```

**ä¿®å¤å»ºè®®ï¼š**
```css
:deep(.van-dialog__footer) {
    display: flex !important;
}

/* æˆ–ä½¿ç”¨å…¨å±€æ ·å¼ */
::v-deep .van-dialog__footer {
    display: flex !important;
}
```

#### 2. APIå…¼å®¹æ€§é—®é¢˜

**é—®é¢˜ä½ç½®ï¼š** `common/Base.js` ç¬¬145è¡Œ

```javascript
wx.requestPayment({
    // ç›´æ¥ä½¿ç”¨wx APIï¼Œå¯èƒ½åœ¨å…¶ä»–å¹³å°ä¸å…¼å®¹
})
```

**æ”¹è¿›å»ºè®®ï¼š**
```javascript
// ä½¿ç”¨æ¡ä»¶ç¼–è¯‘ç¡®ä¿å…¼å®¹æ€§
// #ifdef MP-WEIXIN
wx.requestPayment(paymentData);
// #endif

// #ifdef MP-ALIPAY
my.requestPayment(paymentData);
// #endif

// #ifdef H5
// H5æ”¯ä»˜é€»è¾‘
// #endif
```

---

## ğŸ› ä»£ç è´¨é‡é—®é¢˜

### ğŸŸ¡ ä»£ç è§„èŒƒé—®é¢˜

#### 1. é­”æ³•æ•°å­—å’Œå­—ç¬¦ä¸²

**é—®é¢˜ä½ç½®ï¼š** `App.vue` ç¬¬354è¡Œ

```javascript
if (scanParams.timestamp && (now - scanParams.timestamp) > 300000) { // 5åˆ†é’Ÿ
    // åº”è¯¥å®šä¹‰ä¸ºå¸¸é‡
}
```

**æ”¹è¿›å»ºè®®ï¼š**
```javascript
// å®šä¹‰å¸¸é‡
const CONSTANTS = {
    SCAN_PARAMS_EXPIRE_TIME: 5 * 60 * 1000, // 5åˆ†é’Ÿ
    REQUEST_TIMEOUT: 15000, // 15ç§’
    CACHE_EXPIRE_TIME: 24 * 60 * 60 * 1000 // 24å°æ—¶
};

// ä½¿ç”¨å¸¸é‡
if (scanParams.timestamp && (now - scanParams.timestamp) > CONSTANTS.SCAN_PARAMS_EXPIRE_TIME) {
    // æ‰«ç å‚æ•°å·²è¿‡æœŸ
}
```

#### 2. å¼‚æ­¥æ“ä½œå¤„ç†ä¸å½“

**é—®é¢˜ä½ç½®ï¼š** `App.vue` ç¬¬334è¡Œ

```javascript
setTimeout(() => {
    if (typeof vm.usertap === 'function') {
        vm.usertap();
    }
}, 100); // ç¡¬ç¼–ç å»¶æ—¶
```

**æ”¹è¿›å»ºè®®ï¼š**
```javascript
// ä½¿ç”¨Promiseå’Œasync/await
async function waitForComponent(vm, methodName, maxWait = 3000) {
    const startTime = Date.now();
    
    while (Date.now() - startTime < maxWait) {
        if (vm && typeof vm[methodName] === 'function') {
            return vm[methodName]();
        }
        await new Promise(resolve => setTimeout(resolve, 50));
    }
    
    throw new Error(`Method ${methodName} not available after ${maxWait}ms`);
}

// ä½¿ç”¨
try {
    await waitForComponent(vm, 'usertap');
} catch (error) {
    console.error('Component method call failed:', error);
}
```

#### 3. å†…å­˜æ³„æ¼é£é™©

**é—®é¢˜ä½ç½®ï¼š** `pageone/poweron/poweron.vue`

```javascript
this.timeId = setTimeout(() => {
    // å®šæ—¶å™¨å¯èƒ½æ²¡æœ‰æ­£ç¡®æ¸…ç†
}, 20000);
```

**æ”¹è¿›å»ºè®®ï¼š**
```javascript
// å®šæ—¶å™¨ç®¡ç†ç±»
class TimerManager {
    constructor() {
        this.timers = new Set();
    }
    
    setTimeout(callback, delay) {
        const timerId = setTimeout(() => {
            this.timers.delete(timerId);
            callback();
        }, delay);
        this.timers.add(timerId);
        return timerId;
    }
    
    clearTimeout(timerId) {
        clearTimeout(timerId);
        this.timers.delete(timerId);
    }
    
    clearAll() {
        this.timers.forEach(timerId => clearTimeout(timerId));
        this.timers.clear();
    }
}
```

---

## ğŸ“Š æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•

```javascript
// å»ºè®®æ·»åŠ çš„å•å…ƒæµ‹è¯•
describe('Config', () => {
    test('should have correct API endpoints', () => {
        expect(Config.api).toBe('https://test.yueguisuchong.com/quickuser50/');
        expect(Config.api1).toBe('https://test.yueguisuchong.com/quick_manager50/');
    });
});

describe('Base', () => {
    test('should validate phone number correctly', () => {
        const base = new Base();
        expect(base.checkPhone('13800138000')).toBe(true);
        expect(base.checkPhone('123')).toBe(false);
        expect(base.checkPhone('')).toBe(false);
    });
    
    test('should handle API requests correctly', async () => {
        const base = new Base();
        const mockResponse = { data: { code: 200, data: {} } };
        
        // Mock uni.request
        uni.request = jest.fn().mockImplementation(({ success }) => {
            success(mockResponse);
        });
        
        const result = await base.request('test', 'GET', {});
        expect(result).toEqual(mockResponse);
    });
});
```

### 2. é›†æˆæµ‹è¯•

- **APIè°ƒç”¨æµç¨‹æµ‹è¯•**
  - æµ‹è¯•ç™»å½•æ¥å£è°ƒç”¨
  - æµ‹è¯•å……ç”µæ¥å£è°ƒç”¨
  - æµ‹è¯•æ”¯ä»˜æ¥å£è°ƒç”¨

- **é¡µé¢è·³è½¬æµ‹è¯•**
  - æµ‹è¯•æ‰«ç è·³è½¬æµç¨‹
  - æµ‹è¯•ç™»å½•åé¡µé¢è·³è½¬
  - æµ‹è¯•é”™è¯¯é¡µé¢å¤„ç†

### 3. ç«¯åˆ°ç«¯æµ‹è¯•

```javascript
// ä½¿ç”¨Cypressè¿›è¡ŒE2Eæµ‹è¯•
describe('å……ç”µæµç¨‹', () => {
    it('åº”è¯¥èƒ½å¤Ÿå®Œæˆæ‰«ç å……ç”µ', () => {
        cy.visit('/pages/smcharging/smcharging');
        cy.get('[data-testid="scan-button"]').click();
        cy.get('[data-testid="device-input"]').type('2824C905');
        cy.get('[data-testid="port-input"]').type('01');
        cy.get('[data-testid="confirm-button"]').click();
        cy.url().should('include', '/pageone/poweron/poweron');
    });

    it('åº”è¯¥èƒ½å¤Ÿå®Œæˆç™»å½•æµç¨‹', () => {
        cy.visit('/pages/login/login');
        cy.get('[data-testid="login-button"]').click();
        cy.get('[data-testid="phone-auth"]').click();
        // æ¨¡æ‹Ÿå¾®ä¿¡æˆæƒ
        cy.window().then((win) => {
            win.wx = {
                login: (options) => options.success({ code: 'test-code' })
            };
        });
    });
});
```

### 4. APIç¯å¢ƒå˜æ›´å½±å“è¯„ä¼°

#### 4.1 å·²ç¡®è®¤çš„APIè°ƒç”¨ç‚¹

ç»è¿‡å…¨é¢æ‰«æï¼Œä»¥ä¸‹æ˜¯æ‰€æœ‰ä½¿ç”¨APIçš„å…³é”®ä½ç½®ï¼š

| æ–‡ä»¶ä½ç½® | APIç±»å‹ | å½“å‰çŠ¶æ€ | é£é™©è¯„ä¼° |
|---------|---------|----------|----------|
| `common/Base.js` | ä¸»è¦ä¸šåŠ¡API | âœ… å·²æ›´æ–° | ä½é£é™© |
| `common/Config.js` | é…ç½®ä¸­å¿ƒ | âœ… å·²æ›´æ–° | ä½é£é™© |
| `pages/login/login.vue` | ç™»å½•ç›¸å…³API | âœ… å·²æ›´æ–° | ä½é£é™© |
| `pageone/poweron/poweron.vue` | å……ç”µç›¸å…³API | âœ… å·²æ›´æ–° | ä½é£é™© |
| `common/Base.js` ç¬¬325è¡Œ | ç¬¬ä¸‰æ–¹API | âš ï¸ ç¡¬ç¼–ç  | ä¸­é£é™© |

#### 4.2 WebSocketè¿æ¥æ£€æŸ¥

**WebSocketåœ°å€ï¼š** `wss://test.yueguisuchong.com/quickuser50/device/ws/`

**æ£€æŸ¥ç»“æœï¼š** âœ… å·²æ­£ç¡®æ›´æ–°

**ç›¸å…³æ–‡ä»¶ï¼š**
- `common/Config.js` ç¬¬7è¡Œ
- å……ç”µçŠ¶æ€å®æ—¶ç›‘æ§åŠŸèƒ½

#### 4.3 å›¾ç‰‡èµ„æºAPIæ£€æŸ¥

**å›¾ç‰‡APIåœ°å€ï¼š** `https://test.yueguisuchong.com/quickuser50`

**æ£€æŸ¥ç»“æœï¼š** âœ… å·²æ­£ç¡®æ›´æ–°

**å½±å“åŠŸèƒ½ï¼š**
- ç”¨æˆ·å¤´åƒæ˜¾ç¤º
- å¹¿å‘Šå›¾ç‰‡åŠ è½½
- å…¬ä¼—å·äºŒç»´ç æ˜¾ç¤º

---

## ğŸ” æ·±åº¦ä»£ç åˆ†æ

### 1. å…³é”®ä¸šåŠ¡æµç¨‹åˆ†æ

#### 1.1 æ‰«ç å……ç”µæµç¨‹

**æµç¨‹æ–‡ä»¶ï¼š** `pages/smcharging/smcharging.vue` â†’ `pageone/poweron/poweron.vue`

**å‘ç°é—®é¢˜ï¼š**
```javascript
// pages/smcharging/smcharging.vue ç¬¬274è¡Œ
var device = str.substring(str.length - 11, str.length - 3);
var port = str.substring(str.length - 2, str.length);
// å­—ç¬¦ä¸²æˆªå–é€»è¾‘å¯èƒ½ä¸å¤Ÿå¥å£®
```

**æ”¹è¿›å»ºè®®ï¼š**
```javascript
// æ›´å¥å£®çš„äºŒç»´ç è§£æ
function parseQRCode(qrResult) {
    try {
        // æ”¯æŒå¤šç§äºŒç»´ç æ ¼å¼
        if (qrResult.includes('/')) {
            const parts = qrResult.split('/');
            const device = parts[parts.length - 2];
            const port = parts[parts.length - 1];
            return { device, port };
        }

        // ä¼ ç»Ÿæ ¼å¼è§£æ
        if (qrResult.length >= 11) {
            const device = qrResult.substring(qrResult.length - 11, qrResult.length - 3);
            const port = qrResult.substring(qrResult.length - 2, qrResult.length);
            return { device, port };
        }

        throw new Error('Invalid QR code format');
    } catch (error) {
        console.error('QR code parsing failed:', error);
        return null;
    }
}
```

#### 1.2 æ”¯ä»˜æµç¨‹åˆ†æ

**æ”¯ä»˜æ–¹å¼ï¼š** å¾®ä¿¡æ”¯ä»˜
**å…³é”®æ–‡ä»¶ï¼š** `pageone/poweron/poweron.vue` ç¬¬2180è¡Œ

**å‘ç°é—®é¢˜ï¼š**
```javascript
wx.requestPayment({
    timeStamp: arr.timeStamp,
    nonceStr: arr.nonceStr,
    package: arr.wpackage,
    signType: arr.signType,
    paySign: arr.paySign,
    // ç¼ºå°‘æ”¯ä»˜å‚æ•°éªŒè¯
});
```

**å®‰å…¨å»ºè®®ï¼š**
```javascript
// æ”¯ä»˜å‚æ•°éªŒè¯
function validatePaymentParams(params) {
    const required = ['timeStamp', 'nonceStr', 'wpackage', 'signType', 'paySign'];
    for (const field of required) {
        if (!params[field]) {
            throw new Error(`Missing payment parameter: ${field}`);
        }
    }

    // éªŒè¯æ—¶é—´æˆ³æœ‰æ•ˆæ€§ï¼ˆé˜²æ­¢é‡æ”¾æ”»å‡»ï¼‰
    const timestamp = parseInt(params.timeStamp);
    const now = Math.floor(Date.now() / 1000);
    if (Math.abs(now - timestamp) > 300) { // 5åˆ†é’Ÿæœ‰æ•ˆæœŸ
        throw new Error('Payment timestamp expired');
    }

    return true;
}
```

### 2. æ•°æ®æµåˆ†æ

#### 2.1 ç”¨æˆ·çŠ¶æ€ç®¡ç†

**å­˜å‚¨é”®å€¼ï¼š**
- `userToken`: ç”¨æˆ·è®¤è¯ä»¤ç‰Œ
- `user`: ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- `userId`: ç”¨æˆ·ID
- `phone`: æ‰‹æœºå·
- `Name`: çœŸå®å§“å

**é—®é¢˜åˆ†æï¼š**
```javascript
// App.vue ç¬¬510è¡Œ - ç”¨æˆ·ä¿¡æ¯è®¾ç½®
uni.setStorageSync('user', newUserData);
uni.setStorageSync('userId', newUserData.id);
uni.setStorageSync('userToken', newUserData.token);
// ç¼ºå°‘æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
```

**æ”¹è¿›å»ºè®®ï¼š**
```javascript
// åŸå­æ€§ç”¨æˆ·ä¿¡æ¯æ›´æ–°
function updateUserInfo(userData) {
    try {
        // éªŒè¯æ•°æ®å®Œæ•´æ€§
        if (!userData.id || !userData.token) {
            throw new Error('Invalid user data');
        }

        // åŸå­æ€§æ›´æ–°
        const updates = {
            'user': userData,
            'userId': userData.id,
            'userToken': userData.token,
            'phone': userData.phone,
            'Name': userData.realName
        };

        // æ‰¹é‡æ›´æ–°
        Object.entries(updates).forEach(([key, value]) => {
            if (value !== undefined) {
                uni.setStorageSync(key, value);
            }
        });

        console.log('User info updated successfully');
        return true;
    } catch (error) {
        console.error('Failed to update user info:', error);
        return false;
    }
}
```

#### 2.2 æ‰«ç å‚æ•°ä¼ é€’

**å…¨å±€çŠ¶æ€ï¼š** `App.globalData.scanParams`

**æ•°æ®ç»“æ„ï¼š**
```javascript
{
    device: "2824C905",
    port: "01",
    isFromScan: true,
    timestamp: 1640995200000
}
```

**æ½œåœ¨é—®é¢˜ï¼š**
- æ‰«ç å‚æ•°å¯èƒ½åœ¨é¡µé¢åˆ‡æ¢æ—¶ä¸¢å¤±
- ç¼ºå°‘å‚æ•°æœ‰æ•ˆæ€§éªŒè¯
- æ—¶é—´æˆ³è¿‡æœŸæœºåˆ¶ä¸å¤Ÿå®Œå–„

### 3. é”™è¯¯å¤„ç†åˆ†æ

#### 3.1 ç½‘ç»œé”™è¯¯å¤„ç†

**å½“å‰å®ç°ï¼š** `common/Base.js` ç¬¬232-236è¡Œ

```javascript
fail(res) {
    reject(res)
}
```

**é—®é¢˜ï¼š** é”™è¯¯å¤„ç†è¿‡äºç®€å•ï¼Œç¼ºå°‘åˆ†ç±»å’Œé‡è¯•æœºåˆ¶

**æ”¹è¿›å»ºè®®ï¼š**
```javascript
// å®Œå–„çš„é”™è¯¯å¤„ç†
class NetworkErrorHandler {
    static handle(error, options = {}) {
        const { retry = false, showToast = true } = options;

        // é”™è¯¯åˆ†ç±»
        if (error.statusCode) {
            switch (error.statusCode) {
                case 401:
                    this.handleAuthError();
                    break;
                case 403:
                    this.handlePermissionError();
                    break;
                case 404:
                    this.handleNotFoundError();
                    break;
                case 500:
                    this.handleServerError(retry);
                    break;
                default:
                    this.handleGenericError(error, showToast);
            }
        } else {
            this.handleNetworkError(retry);
        }
    }

    static handleAuthError() {
        uni.showModal({
            title: 'ç™»å½•å·²è¿‡æœŸ',
            content: 'è¯·é‡æ–°ç™»å½•',
            success: (res) => {
                if (res.confirm) {
                    uni.navigateTo({
                        url: '/pages/login/login'
                    });
                }
            }
        });
    }

    static handleNetworkError(retry) {
        if (retry) {
            uni.showModal({
                title: 'ç½‘ç»œé”™è¯¯',
                content: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæ˜¯å¦é‡è¯•ï¼Ÿ',
                success: (res) => {
                    if (res.confirm) {
                        // é‡è¯•é€»è¾‘
                    }
                }
            });
        } else {
            uni.showToast({
                title: 'ç½‘ç»œè¿æ¥å¤±è´¥',
                icon: 'none'
            });
        }
    }
}
```

---

## ğŸ›¡ï¸ å®‰å…¨åŠ å›ºå»ºè®®

### 1. æ•°æ®åŠ å¯†

#### 1.1 æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨

**å½“å‰é—®é¢˜ï¼š** ç”¨æˆ·tokenç­‰æ•æ„Ÿä¿¡æ¯æ˜æ–‡å­˜å‚¨

**åŠ å›ºæ–¹æ¡ˆï¼š**
```javascript
// ç®€å•çš„æ•°æ®åŠ å¯†å·¥å…·
class SecureStorage {
    static encrypt(data) {
        // ä½¿ç”¨ç®€å•çš„Base64ç¼–ç ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ›´å¼ºçš„åŠ å¯†ï¼‰
        return btoa(JSON.stringify(data));
    }

    static decrypt(encryptedData) {
        try {
            return JSON.parse(atob(encryptedData));
        } catch {
            return null;
        }
    }

    static setItem(key, value) {
        const encrypted = this.encrypt(value);
        uni.setStorageSync(key, encrypted);
    }

    static getItem(key) {
        const encrypted = uni.getStorageSync(key);
        return encrypted ? this.decrypt(encrypted) : null;
    }
}
```

#### 1.2 APIè¯·æ±‚ç­¾å

**å»ºè®®å®ç°ï¼š**
```javascript
// APIè¯·æ±‚ç­¾å
class APISignature {
    static generateSignature(params, secret) {
        const sortedParams = Object.keys(params)
            .sort()
            .map(key => `${key}=${params[key]}`)
            .join('&');

        // ç®€å•çš„HMAC-likeç­¾åï¼ˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨çœŸæ­£çš„HMACï¼‰
        return btoa(sortedParams + secret);
    }

    static signRequest(data) {
        const timestamp = Date.now();
        const nonce = Math.random().toString(36).substr(2, 15);

        const signParams = {
            ...data,
            timestamp,
            nonce
        };

        const signature = this.generateSignature(signParams, 'your-secret-key');

        return {
            ...signParams,
            signature
        };
    }
}
```

### 2. è¾“å…¥éªŒè¯åŠ å¼º

#### 2.1 è®¾å¤‡IDéªŒè¯

```javascript
// è®¾å¤‡IDæ ¼å¼éªŒè¯
function validateDeviceId(deviceId) {
    // è®¾å¤‡IDåº”è¯¥æ˜¯8ä½åå…­è¿›åˆ¶å­—ç¬¦
    const devicePattern = /^[A-Fa-f0-9]{8}$/;

    if (!devicePattern.test(deviceId)) {
        throw new Error('Invalid device ID format');
    }

    return deviceId.toUpperCase();
}

// ç«¯å£å·éªŒè¯
function validatePort(port) {
    // ç«¯å£å·åº”è¯¥æ˜¯2ä½åå…­è¿›åˆ¶æˆ–FF
    const portPattern = /^([A-Fa-f0-9]{2}|FF)$/i;

    if (!portPattern.test(port)) {
        throw new Error('Invalid port format');
    }

    return port.toUpperCase();
}
```

#### 2.2 é‡‘é¢éªŒè¯

```javascript
// å……å€¼é‡‘é¢éªŒè¯
function validateAmount(amount) {
    const numAmount = parseFloat(amount);

    if (isNaN(numAmount) || numAmount <= 0) {
        throw new Error('Invalid amount');
    }

    if (numAmount > 10000) {
        throw new Error('Amount too large');
    }

    if (!/^\d+(\.\d{1,2})?$/.test(amount.toString())) {
        throw new Error('Invalid amount format');
    }

    return numAmount;
}
```

---

## ğŸ“± ç§»åŠ¨ç«¯é€‚é…é—®é¢˜

### 1. å±å¹•é€‚é…

#### 1.1 rpxå•ä½ä½¿ç”¨

**æ£€æŸ¥ç»“æœï¼š** å¤§éƒ¨åˆ†ä½¿ç”¨äº†rpxå•ä½ï¼Œä½†å­˜åœ¨éƒ¨åˆ†pxå•ä½

**é—®é¢˜ç¤ºä¾‹ï¼š**
```css
/* uni.scss ç¬¬58è¡Œ */
$uni-spacing-row-sm: 10px; /* åº”è¯¥ä½¿ç”¨rpx */
```

**å»ºè®®ä¿®æ”¹ï¼š**
```css
$uni-spacing-row-sm: 20rpx;
$uni-spacing-row-base: 40rpx;
$uni-spacing-row-lg: 60rpx;
```

#### 1.2 å®‰å…¨åŒºåŸŸé€‚é…

**ç¼ºå¤±é—®é¢˜ï¼š** æœªè€ƒè™‘iPhone Xç­‰è®¾å¤‡çš„å®‰å…¨åŒºåŸŸ

**å»ºè®®æ·»åŠ ï¼š**
```css
/* å®‰å…¨åŒºåŸŸé€‚é… */
.safe-area-bottom {
    padding-bottom: constant(safe-area-inset-bottom);
    padding-bottom: env(safe-area-inset-bottom);
}

.safe-area-top {
    padding-top: constant(safe-area-inset-top);
    padding-top: env(safe-area-inset-top);
}
```

### 2. æ€§èƒ½ä¼˜åŒ–

#### 2.1 å›¾ç‰‡æ‡’åŠ è½½

**å»ºè®®å®ç°ï¼š**
```javascript
// å›¾ç‰‡æ‡’åŠ è½½ç»„ä»¶
Vue.component('lazy-image', {
    props: ['src', 'placeholder'],
    data() {
        return {
            loaded: false,
            inView: false
        };
    },
    mounted() {
        this.observer = uni.createIntersectionObserver(this);
        this.observer.observe('.lazy-image', (res) => {
            if (res.intersectionRatio > 0) {
                this.inView = true;
                this.observer.disconnect();
            }
        });
    },
    template: `
        <image
            class="lazy-image"
            :src="inView ? src : placeholder"
            @load="loaded = true"
            :class="{ 'loaded': loaded }"
        />
    `
});
```

#### 2.2 åˆ—è¡¨è™šæ‹Ÿæ»šåŠ¨

**é€‚ç”¨åœºæ™¯ï¼š** å……ç”µè®°å½•ã€æ¶ˆè´¹è®°å½•ç­‰é•¿åˆ—è¡¨

**å»ºè®®å®ç°ï¼š**
```javascript
// è™šæ‹Ÿæ»šåŠ¨åˆ—è¡¨
export default {
    data() {
        return {
            itemHeight: 100, // æ¯é¡¹é«˜åº¦
            visibleCount: 10, // å¯è§é¡¹æ•°é‡
            scrollTop: 0,
            allData: [] // å…¨éƒ¨æ•°æ®
        };
    },
    computed: {
        visibleData() {
            const start = Math.floor(this.scrollTop / this.itemHeight);
            const end = start + this.visibleCount;
            return this.allData.slice(start, end);
        },
        offsetY() {
            return Math.floor(this.scrollTop / this.itemHeight) * this.itemHeight;
        }
    },
    methods: {
        onScroll(e) {
            this.scrollTop = e.detail.scrollTop;
        }
    }
};
```

---

## ğŸš€ ä¼˜åŒ–å»ºè®®ä¼˜å…ˆçº§

### ğŸ”´ ç«‹å³ä¿®å¤ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

1. **APIå¯†é’¥å®‰å…¨é—®é¢˜**
   - ç§»é™¤å‰ç«¯ç¡¬ç¼–ç çš„APIå¯†é’¥
   - å®æ–½æœåŠ¡ç«¯ä»£ç†æ–¹æ¡ˆ

2. **URLå®‰å…¨éªŒè¯**
   - æ·»åŠ URLç™½åå•æœºåˆ¶
   - å®æ–½XSSé˜²æŠ¤

3. **ç¯å¢ƒé…ç½®ç®¡ç†**
   - å®æ–½ç¯å¢ƒå˜é‡ç®¡ç†
   - åˆ†ç¦»å¼€å‘å’Œç”Ÿäº§é…ç½®

### ğŸŸ¡ ä¸­æœŸä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

1. **æ€§èƒ½ä¼˜åŒ–**
   - å®æ–½è¯·æ±‚ç¼“å­˜æœºåˆ¶
   - ä¼˜åŒ–å­˜å‚¨è¯»å–é¢‘ç‡
   - å›¾ç‰‡èµ„æºä¼˜åŒ–

2. **ä»£ç é‡æ„**
   - æ¶ˆé™¤é‡å¤ä»£ç 
   - ç»Ÿä¸€é”™è¯¯å¤„ç†
   - æ”¹è¿›å¼‚æ­¥æ“ä½œ

3. **ç”¨æˆ·ä½“éªŒæå‡**
   - ç»Ÿä¸€åŠ è½½çŠ¶æ€
   - æ”¹è¿›é”™è¯¯æç¤º
   - æ·»åŠ æ— éšœç¢æ”¯æŒ

### ğŸŸ¢ é•¿æœŸæ”¹è¿›ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

1. **æ¶æ„å‡çº§**
   - å¼•å…¥çŠ¶æ€ç®¡ç†
   - ç»„ä»¶åŒ–é‡æ„
   - æ·»åŠ TypeScriptæ”¯æŒ

2. **æµ‹è¯•å®Œå–„**
   - å»ºç«‹å•å…ƒæµ‹è¯•ä½“ç³»
   - å®æ–½E2Eæµ‹è¯•
   - æ·»åŠ æ€§èƒ½ç›‘æ§

---

## ğŸ“‹ æ€»ç»“

### âœ… ç§¯ææ–¹é¢

1. **APIé…ç½®æ­£ç¡®**ï¼šå½“å‰APIåœ°å€å·²æ­£ç¡®æ›´æ–°ä¸ºæ–°çš„ç”Ÿäº§ç¯å¢ƒåœ°å€
2. **åŠŸèƒ½å®Œæ•´**ï¼šå°ç¨‹åºåŠŸèƒ½æ¨¡å—é½å…¨ï¼Œè¦†ç›–å……ç”µæ¡©çš„ä¸»è¦ä½¿ç”¨åœºæ™¯
3. **æ¡†æ¶é€‰æ‹©åˆç†**ï¼šä½¿ç”¨uni-appæ¡†æ¶ï¼Œå…·æœ‰è‰¯å¥½çš„è·¨å¹³å°å…¼å®¹æ€§

### âš ï¸ éœ€è¦å…³æ³¨çš„é—®é¢˜

1. **å®‰å…¨æ€§é—®é¢˜**ï¼šå­˜åœ¨APIå¯†é’¥æ³„éœ²å’ŒXSSé£é™©
2. **ä»£ç è´¨é‡**ï¼šå­˜åœ¨é‡å¤ä»£ç å’Œä¸è§„èŒƒçš„å¼‚æ­¥å¤„ç†
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šå­˜åœ¨é¢‘ç¹å­˜å‚¨è¯»å–å’Œç½‘ç»œè¯·æ±‚ä¼˜åŒ–ç©ºé—´

### ğŸ¯ å»ºè®®çš„æ”¹è¿›è·¯å¾„

1. **ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰**ï¼šä¿®å¤å®‰å…¨é—®é¢˜å’ŒAPIé…ç½®é—®é¢˜
2. **ç¬¬äºŒé˜¶æ®µï¼ˆ2-4å‘¨ï¼‰**ï¼šæ€§èƒ½ä¼˜åŒ–å’Œä»£ç é‡æ„
3. **ç¬¬ä¸‰é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰**ï¼šç”¨æˆ·ä½“éªŒæå‡å’Œæµ‹è¯•å®Œå–„

---

## ğŸ”§ å…·ä½“ä¿®å¤æ–¹æ¡ˆ

### 1. ç«‹å³æ‰§è¡Œçš„ä¿®å¤è„šæœ¬

#### 1.1 ç¯å¢ƒé…ç½®ä¼˜åŒ–è„šæœ¬

```javascript
// scripts/config-setup.js
const fs = require('fs');
const path = require('path');

// åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
const createConfigFile = () => {
    const configTemplate = `
// config/environment.js
const ENV = process.env.NODE_ENV || 'production';

const configs = {
  development: {
    baseUrl: "https://test.yueguisuchong.com",
    api: "https://test.yueguisuchong.com/quickuser50/",
    api1: "https://test.yueguisuchong.com/quick_manager50/",
    wx: "wss://test.yueguisuchong.com/quickuser50/device/ws/",
    imgapi: "https://test.yueguisuchong.com/quickuser50",
    imgUrl: "https://test.yueguisuchong.com/tabBarimg/"
  },
  production: {
    baseUrl: "https://test.yueguisuchong.com",
    api: "https://test.yueguisuchong.com/quickuser50/",
    api1: "https://test.yueguisuchong.com/quick_manager50/",
    wx: "wss://test.yueguisuchong.com/quickuser50/device/ws/",
    imgapi: "https://test.yueguisuchong.com/quickuser50",
    imgUrl: "https://test.yueguisuchong.com/tabBarimg/"
  }
};

export const Config = configs[ENV];
`;

    fs.writeFileSync(path.join(__dirname, '../config/environment.js'), configTemplate);
    console.log('âœ… ç¯å¢ƒé…ç½®æ–‡ä»¶å·²åˆ›å»º');
};

createConfigFile();
```

#### 1.2 å®‰å…¨æ£€æŸ¥è„šæœ¬

```javascript
// scripts/security-check.js
const fs = require('fs');
const path = require('path');

const securityIssues = [];

// æ£€æŸ¥APIå¯†é’¥æ³„éœ²
const checkApiKeys = (filePath, content) => {
    const keyPatterns = [
        /key.*["\']([A-Z0-9-]{20,})["\']/, // é€šç”¨APIå¯†é’¥
        /secret.*["\']([A-Za-z0-9-]{20,})["\']/, // å¯†é’¥
        /token.*["\']([A-Za-z0-9-]{20,})["\']/ // Token
    ];

    keyPatterns.forEach(pattern => {
        const match = content.match(pattern);
        if (match) {
            securityIssues.push({
                file: filePath,
                issue: 'APIå¯†é’¥æ³„éœ²',
                line: content.substring(0, match.index).split('\n').length,
                severity: 'HIGH'
            });
        }
    });
};

// æ£€æŸ¥ç¡¬ç¼–ç URL
const checkHardcodedUrls = (filePath, content) => {
    const urlPattern = /https?:\/\/[^\s"']+/g;
    const matches = content.match(urlPattern);

    if (matches) {
        matches.forEach(url => {
            if (!url.includes('test.yueguisuchong.com')) {
                securityIssues.push({
                    file: filePath,
                    issue: `ç¡¬ç¼–ç URL: ${url}`,
                    severity: 'MEDIUM'
                });
            }
        });
    }
};

// æ‰«ææ–‡ä»¶
const scanDirectory = (dir) => {
    const files = fs.readdirSync(dir);

    files.forEach(file => {
        const filePath = path.join(dir, file);
        const stat = fs.statSync(filePath);

        if (stat.isDirectory() && !file.startsWith('.')) {
            scanDirectory(filePath);
        } else if (file.endsWith('.js') || file.endsWith('.vue') || file.endsWith('.json')) {
            const content = fs.readFileSync(filePath, 'utf8');
            checkApiKeys(filePath, content);
            checkHardcodedUrls(filePath, content);
        }
    });
};

// æ‰§è¡Œæ‰«æ
scanDirectory(path.join(__dirname, '..'));

// è¾“å‡ºç»“æœ
if (securityIssues.length > 0) {
    console.log('ğŸš¨ å‘ç°å®‰å…¨é—®é¢˜:');
    securityIssues.forEach(issue => {
        console.log(`${issue.severity}: ${issue.file} - ${issue.issue}`);
    });
} else {
    console.log('âœ… æœªå‘ç°æ˜æ˜¾å®‰å…¨é—®é¢˜');
}
```

### 2. ä»£ç è´¨é‡æ”¹è¿›æ¨¡æ¿

#### 2.1 ç»Ÿä¸€é”™è¯¯å¤„ç†å™¨

```javascript
// utils/error-handler.js
class ErrorHandler {
    static handle(error, context = '') {
        console.error(`[${context}] Error:`, error);

        // é”™è¯¯åˆ†ç±»å¤„ç†
        if (error.code) {
            switch (error.code) {
                case 70004:
                case 401:
                    this.handleAuthError();
                    break;
                case 403:
                    this.handlePermissionError();
                    break;
                case 404:
                    this.handleNotFoundError();
                    break;
                case 500:
                    this.handleServerError();
                    break;
                default:
                    this.handleGenericError(error);
            }
        } else {
            this.handleNetworkError(error);
        }
    }

    static handleAuthError() {
        uni.showModal({
            title: 'ç™»å½•å·²è¿‡æœŸ',
            content: 'è¯·é‡æ–°ç™»å½•ä»¥ç»§ç»­ä½¿ç”¨',
            showCancel: false,
            success: () => {
                uni.reLaunch({
                    url: '/pages/login/login'
                });
            }
        });
    }

    static handleNetworkError(error) {
        uni.showToast({
            title: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
            icon: 'none',
            duration: 3000
        });
    }

    static handleGenericError(error) {
        const message = error.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
        uni.showToast({
            title: message,
            icon: 'none',
            duration: 2000
        });
    }
}

export default ErrorHandler;
```

#### 2.2 ç»Ÿä¸€è¯·æ±‚æ‹¦æˆªå™¨

```javascript
// utils/request-interceptor.js
import ErrorHandler from './error-handler.js';

class RequestInterceptor {
    constructor() {
        this.requestQueue = new Map();
        this.retryCount = new Map();
    }

    // è¯·æ±‚å»é‡
    deduplicateRequest(url, method, data) {
        const key = `${method}:${url}:${JSON.stringify(data)}`;

        if (this.requestQueue.has(key)) {
            return this.requestQueue.get(key);
        }

        const promise = this.makeRequest(url, method, data);
        this.requestQueue.set(key, promise);

        // è¯·æ±‚å®Œæˆåæ¸…é™¤
        promise.finally(() => {
            this.requestQueue.delete(key);
        });

        return promise;
    }

    // è¯·æ±‚é‡è¯•
    async retryRequest(url, method, data, maxRetries = 3) {
        const key = `${method}:${url}`;
        let retries = this.retryCount.get(key) || 0;

        try {
            const result = await this.makeRequest(url, method, data);
            this.retryCount.delete(key);
            return result;
        } catch (error) {
            if (retries < maxRetries && this.shouldRetry(error)) {
                this.retryCount.set(key, retries + 1);
                await this.delay(1000 * Math.pow(2, retries)); // æŒ‡æ•°é€€é¿
                return this.retryRequest(url, method, data, maxRetries);
            }

            this.retryCount.delete(key);
            throw error;
        }
    }

    shouldRetry(error) {
        // ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯å¯ä»¥é‡è¯•
        return !error.statusCode || error.statusCode >= 500;
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    makeRequest(url, method, data) {
        return new Promise((resolve, reject) => {
            uni.request({
                url,
                method,
                data,
                timeout: 15000,
                success: resolve,
                fail: reject
            });
        });
    }
}

export default new RequestInterceptor();
```

### 3. æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ

#### 3.1 æ€§èƒ½ç›‘æ§å·¥å…·

```javascript
// utils/performance-monitor.js
class PerformanceMonitor {
    constructor() {
        this.metrics = new Map();
        this.startTimes = new Map();
    }

    // å¼€å§‹è®¡æ—¶
    start(label) {
        this.startTimes.set(label, Date.now());
    }

    // ç»“æŸè®¡æ—¶
    end(label) {
        const startTime = this.startTimes.get(label);
        if (startTime) {
            const duration = Date.now() - startTime;
            this.metrics.set(label, duration);
            this.startTimes.delete(label);

            // è®°å½•æ…¢æ“ä½œ
            if (duration > 1000) {
                console.warn(`Slow operation detected: ${label} took ${duration}ms`);
            }

            return duration;
        }
        return 0;
    }

    // è·å–æ€§èƒ½æŠ¥å‘Š
    getReport() {
        const report = {};
        this.metrics.forEach((duration, label) => {
            report[label] = duration;
        });
        return report;
    }

    // æ¸…é™¤æŒ‡æ ‡
    clear() {
        this.metrics.clear();
        this.startTimes.clear();
    }
}

export default new PerformanceMonitor();
```

#### 3.2 å†…å­˜æ³„æ¼æ£€æµ‹

```javascript
// utils/memory-monitor.js
class MemoryMonitor {
    constructor() {
        this.timers = new Set();
        this.intervals = new Set();
        this.observers = new Set();
    }

    // å®‰å…¨çš„setTimeout
    setTimeout(callback, delay) {
        const timerId = setTimeout(() => {
            this.timers.delete(timerId);
            callback();
        }, delay);

        this.timers.add(timerId);
        return timerId;
    }

    // å®‰å…¨çš„setInterval
    setInterval(callback, delay) {
        const intervalId = setInterval(callback, delay);
        this.intervals.add(intervalId);
        return intervalId;
    }

    // æ¸…é™¤å®šæ—¶å™¨
    clearTimeout(timerId) {
        clearTimeout(timerId);
        this.timers.delete(timerId);
    }

    clearInterval(intervalId) {
        clearInterval(intervalId);
        this.intervals.delete(intervalId);
    }

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    cleanup() {
        this.timers.forEach(timerId => clearTimeout(timerId));
        this.intervals.forEach(intervalId => clearInterval(intervalId));
        this.observers.forEach(observer => observer.disconnect());

        this.timers.clear();
        this.intervals.clear();
        this.observers.clear();
    }
}

export default MemoryMonitor;
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### ğŸ”´ é«˜ä¼˜å…ˆçº§ä¿®å¤æ¸…å•

- [ ] **ç§»é™¤APIå¯†é’¥** - ä»manifest.jsonä¸­ç§»é™¤è…¾è®¯åœ°å›¾APIå¯†é’¥
- [ ] **URLå®‰å…¨éªŒè¯** - ä¸ºgogdå‡½æ•°æ·»åŠ URLç™½åå•éªŒè¯
- [ ] **ç¯å¢ƒé…ç½®åˆ†ç¦»** - å®æ–½ç¯å¢ƒå˜é‡ç®¡ç†æ–¹æ¡ˆ
- [ ] **è¾“å…¥éªŒè¯åŠ å¼º** - å®Œå–„æ‰‹æœºå·ã€è®¾å¤‡IDç­‰è¾“å…¥éªŒè¯
- [ ] **é”™è¯¯å¤„ç†ç»Ÿä¸€** - å®æ–½ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–æ¸…å•

- [ ] **ä»£ç é‡æ„** - åˆå¹¶requestå’Œrequest1æ–¹æ³•
- [ ] **æ€§èƒ½ä¼˜åŒ–** - å®æ–½å­˜å‚¨ç¼“å­˜æœºåˆ¶
- [ ] **æ ·å¼å…¼å®¹æ€§** - ä¿®å¤/deep/è¯­æ³•é—®é¢˜
- [ ] **å¼‚æ­¥å¤„ç†** - æ”¹è¿›setTimeoutç¡¬ç¼–ç é—®é¢˜
- [ ] **å†…å­˜ç®¡ç†** - æ·»åŠ å®šæ—¶å™¨æ¸…ç†æœºåˆ¶

### ğŸŸ¢ ä½ä¼˜å…ˆçº§æ”¹è¿›æ¸…å•

- [ ] **å•å…ƒæµ‹è¯•** - æ·»åŠ æ ¸å¿ƒåŠŸèƒ½å•å…ƒæµ‹è¯•
- [ ] **E2Eæµ‹è¯•** - å®æ–½ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] **æ€§èƒ½ç›‘æ§** - æ·»åŠ æ€§èƒ½ç›‘æ§å·¥å…·
- [ ] **æ— éšœç¢æ”¯æŒ** - æ”¹è¿›æ— éšœç¢è®¿é—®
- [ ] **æ–‡æ¡£å®Œå–„** - è¡¥å……ä»£ç æ–‡æ¡£

---

## ğŸ¯ å®æ–½å»ºè®®

### ç¬¬ä¸€å‘¨ï¼šå®‰å…¨ä¿®å¤
1. ç§»é™¤æ‰€æœ‰ç¡¬ç¼–ç çš„APIå¯†é’¥
2. å®æ–½URLç™½åå•éªŒè¯
3. åŠ å¼ºè¾“å…¥éªŒè¯æœºåˆ¶
4. ç»Ÿä¸€é”™è¯¯å¤„ç†

### ç¬¬äºŒå‘¨ï¼šæ€§èƒ½ä¼˜åŒ–
1. å®æ–½å­˜å‚¨ç¼“å­˜æœºåˆ¶
2. ä¼˜åŒ–ç½‘ç»œè¯·æ±‚
3. æ·»åŠ è¯·æ±‚å»é‡å’Œé‡è¯•
4. å›¾ç‰‡èµ„æºä¼˜åŒ–

### ç¬¬ä¸‰å‘¨ï¼šä»£ç è´¨é‡
1. é‡æ„é‡å¤ä»£ç 
2. æ”¹è¿›å¼‚æ­¥å¤„ç†
3. æ·»åŠ å†…å­˜ç®¡ç†
4. å®Œå–„é”™è¯¯å¤„ç†

### ç¬¬å››å‘¨ï¼šæµ‹è¯•å’Œç›‘æ§
1. æ·»åŠ å•å…ƒæµ‹è¯•
2. å®æ–½æ€§èƒ½ç›‘æ§
3. å®Œå–„æ–‡æ¡£
4. ä»£ç å®¡æŸ¥

---

## ğŸ“Š é£é™©è¯„ä¼°çŸ©é˜µ

| é—®é¢˜ç±»å‹ | å½±å“ç¨‹åº¦ | å‘ç”Ÿæ¦‚ç‡ | é£é™©ç­‰çº§ | å»ºè®®å¤„ç†æ—¶é—´ |
|---------|---------|---------|---------|-------------|
| APIå¯†é’¥æ³„éœ² | é«˜ | ä¸­ | ğŸ”´ é«˜ | ç«‹å³ |
| XSSæ”»å‡» | é«˜ | ä½ | ğŸŸ¡ ä¸­ | 1å‘¨å†… |
| æ€§èƒ½é—®é¢˜ | ä¸­ | é«˜ | ğŸŸ¡ ä¸­ | 2å‘¨å†… |
| å…¼å®¹æ€§é—®é¢˜ | ä¸­ | ä¸­ | ğŸŸ¡ ä¸­ | 2å‘¨å†… |
| ä»£ç è´¨é‡ | ä½ | é«˜ | ğŸŸ¢ ä½ | 1æœˆå†… |

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### è”ç³»æ–¹å¼
- **æŠ€æœ¯è´Ÿè´£äººï¼š** [å¾…å¡«å†™]
- **ç´§æ€¥è”ç³»ï¼š** [å¾…å¡«å†™]
- **ä»£ç ä»“åº“ï¼š** https://github.com/Bigwq3721/66_Chargingpile_applet_2.0

### ç›¸å…³æ–‡æ¡£
- [uni-appå®˜æ–¹æ–‡æ¡£](https://uniapp.dcloud.io/)
- [å¾®ä¿¡å°ç¨‹åºå¼€å‘æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [Vant Weappç»„ä»¶åº“](https://youzan.github.io/vant-weapp/)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š** 2024å¹´12æœˆ19æ—¥
**æµ‹è¯•å·¥å…·ï¼š** ä»£ç é™æ€åˆ†æ + äººå·¥å®¡æŸ¥
**å»ºè®®å¤æŸ¥å‘¨æœŸï¼š** æ¯æœˆä¸€æ¬¡
**ä¸‹æ¬¡å¤æŸ¥æ—¶é—´ï¼š** 2025å¹´1æœˆ19æ—¥

---

*æœ¬æŠ¥å‘ŠåŸºäºå½“å‰ä»£ç çŠ¶æ€ç”Ÿæˆï¼Œå»ºè®®å®šæœŸæ›´æ–°ä»¥åæ˜ æœ€æ–°çš„ä»£ç å˜æ›´å’Œä¼˜åŒ–è¿›å±•ã€‚å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦æŠ€æœ¯æ”¯æŒï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚*
